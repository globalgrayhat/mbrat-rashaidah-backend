# NestJS Backend with passport Authentication

This is a NestJS backend application that uses passport for authentication and MySQL with TypeORM for data management.

## Features

- User authentication with passport
- JWT-based session management
- Role-based access control
- Admin dashboard with user management
- Secure database interactions with TypeORM
- Environment-based configuration

## üì¶ Platform Features

- ‚úÖ **User & Account Management**

  - User registration and login
  - OTP verification for added security
  - Token refresh and JWT session handling
  - Admin dashboard with role and access control

- üèóÔ∏è **Charity Project Management**

  - Create, update, and delete projects
  - Filter by category, country, or status
  - View detailed project information and statistics

- üéØ **Campaigns Module**

  - Launch and manage fundraising campaigns
  - Link campaigns to specific projects
  - Full CRUD support for campaigns

- üí∏ **Donations System**

  - Donate directly to specific projects
  - View and manage individual donations
  - Integration with **Stripe** and **MyFatoora** for secure payments
  - Webhook support for real-time payment updates

- üåç **Geographical Classification**

  - Manage countries and continents
  - Assign projects to specific regions

- üß≠ **Categories Management**

  - Define and manage categories for projects
  - Support for slug-based lookup and filtering

- üì¢ **Banner & Promotion System**

  - Manage promotional banners across the platform
  - Upload media and assign to banners

- üñºÔ∏è **Media Library**

  - Upload and manage images and media files
  - View raw media data and metadata

- ‚úâÔ∏è **Email Integration**

  - Send verification or notification emails
  - SMTP configuration via environment variables

- üõ°Ô∏è **Security & Access Control**

  - JWT-based authentication
  - Role-based permissions (user, admin, super_admin)
  - Request validation and password encryption
  - Protected admin routes

## Prerequisites

- Node.js (v20.18.0 or higher)
- MySQL database

## Installation

1. Clone the repository:

```bash
git clone https://github.com/globalgrayhat/mbrat-rashaidah-backend.git
cd mbrat-rashaidah-backend
```

2. Install dependencies:

```bash
npm i
```

3. Create a `.env` file in the root directory with the following variables:

```env
# App Config
APP_NAME=mbrat-rashaidah-backend
PORT=3003
ALLOWED_ORIGINS=https://localhost,https://admin.localhost
BASE_DOMAIN=localhost
API_DOMAIN=localhost
# Environment
NODE_ENV=development
# Database
TYPE_DATABASE=mysql
HOST_DATABASE=localhost
PORT_DATABASE=3306
USER_DATABASE=root
PASSWORD_DATABASE=
NAME_DATABASE=mbrat_rashaidah
# JWT Access Token
JWT_ACCESS_SECRET=your_supabase_jwt_secret
JWT_EXPIRATION=30m
# JWT Refresh Token
JWT_REFRESH_SECRET=my_refresh_token_secret_456
JWT_REFRESH_EXPIRATION=2h
# OTP
OTP_ENABLED=false
EXP_MINUTES=2
OTP_LENGTH=6
# Mail
MAIL_HOST=smtp.gmail.com
MAIL_PORT=465
MAIL_SECURE=SSL
MAIL_USER=studentofthecourse@gmail.com
MAIL_PASS=sdfsfssfgfssvsavvrv
MAIL_FROM=studentofthecourse@gmail.com
MAIL_FROM_NAME=No‚ÄëReply
# Payment
# Stripe
STRIPE_SECRET_KEY=nsjsdjabsdjab
STRIPE_WEBHOOK_SECRET=nsjsdjabsdjab
# Myfatoora
MYFATOORA_BASE_URL=https://api.myfatoorah.com
MYFATOORA_API_KEY=your_api_key_here
MYFATOORA_SUCCESS_URL=https://yourapp.com/payments/myfatoora/success
MYFATOORA_ERROR_URL=https://yourapp.com/payments/myfatoora/cancel
MYFATOORA_WEBHOOK_SECRET=optional_webhook_secret
```

4. Set up the database:

```bash
npm run typeorm migration:run
```

## Running the Application

Development mode:

```bash
npm run start:dev
```

Production mode:

```bash
npm run build
npm run start:prod
```

## API Endpoints

### User & Authentication

| Method | Path               | Description              |
| ------ | ------------------ | ------------------------ |
| POST   | `/auth/register`   | Register a new user      |
| POST   | `/auth/login`      | Log in and receive JWT   |
| POST   | `/auth/otp-verify` | Verify OTP code          |
| POST   | `/auth/refresh`    | Refresh JWT token        |
| GET    | `/auth/profile`    | Get current user profile |

### Users

| Method | Path         | Description       |
| ------ | ------------ | ----------------- |
| POST   | `/users`     | Create a new user |
| GET    | `/users`     | List all users    |
| GET    | `/users/:id` | Get user by ID    |
| PUT    | `/users/:id` | Update user by ID |
| DELETE | `/users/:id` | Delete user by ID |

### Admin (Role Management)

| Method | Path                    | Description                   |
| ------ | ----------------------- | ----------------------------- |
| GET    | `/admin/users`          | List all users (admin only)   |
| GET    | `/admin/users/:id`      | Get user by ID (admin only)   |
| POST   | `/admin/users/:id/role` | Change user role (admin only) |
| DELETE | `/admin/users/:id`      | Delete user (admin only)      |

### Banners

| Method | Path           | Description         |
| ------ | -------------- | ------------------- |
| POST   | `/banners`     | Create a banner     |
| GET    | `/banners`     | List all banners    |
| GET    | `/banners/:id` | Get banner by ID    |
| PATCH  | `/banners/:id` | Update banner by ID |
| DELETE | `/banners/:id` | Delete banner by ID |

### Projects

| Method | Path                             | Description                    |
| ------ | -------------------------------- | ------------------------------ |
| POST   | `/projects`                      | Create a new project           |
| GET    | `/projects`                      | List all projects              |
| GET    | `/projects/:id`                  | Get project by ID              |
| PATCH  | `/projects/:id`                  | Update project by ID           |
| DELETE | `/projects/:id`                  | Delete project by ID           |
| GET    | `/projects/category/:categoryId` | List projects by category      |
| GET    | `/projects/country/:countryId`   | List projects by country       |
| GET    | `/projects/status/:status`       | List projects by status        |
| GET    | `/projects/details/:projectId`   | Get project details with stats |
| GET    | `/projects/stats/summary`        | Get summary statistics         |

### Categories

| Method | Path                     | Description           |
| ------ | ------------------------ | --------------------- |
| POST   | `/categories`            | Create a new category |
| GET    | `/categories`            | List all categories   |
| GET    | `/categories/:id`        | Get category by ID    |
| GET    | `/categories/slug/:slug` | Get category by slug  |
| PATCH  | `/categories/:id`        | Update category by ID |
| DELETE | `/categories/:id`        | Delete category by ID |

### Countries

| Method | Path             | Description          |
| ------ | ---------------- | -------------------- |
| POST   | `/countries`     | Create a new country |
| GET    | `/countries`     | List all countries   |
| GET    | `/countries/:id` | Get country by ID    |
| PUT    | `/countries/:id` | Update country by ID |
| DELETE | `/countries/:id` | Delete country by ID |

### Continents

| Method | Path              | Description            |
| ------ | ----------------- | ---------------------- |
| POST   | `/continents`     | Create a new continent |
| GET    | `/continents`     | List all continents    |
| GET    | `/continents/:id` | Get continent by ID    |
| PUT    | `/continents/:id` | Update continent by ID |
| DELETE | `/continents/:id` | Delete continent by ID |

### Media

| Method | Path              | Description                |
| ------ | ----------------- | -------------------------- |
| POST   | `/media/upload`   | Upload a media file        |
| GET    | `/media`          | List all media             |
| GET    | `/media/:id`      | Get media metadata by ID   |
| GET    | `/media/:id/data` | Download media binary data |
| PATCH  | `/media/:id`      | Update media metadata      |
| DELETE | `/media/:id`      | Delete media by ID         |

### Campaigns

| Method | Path             | Description           |
| ------ | ---------------- | --------------------- |
| GET    | `/campaigns`     | List all campaigns    |
| POST   | `/campaigns`     | Create a new campaign |
| GET    | `/campaigns/:id` | Get campaign by ID    |
| PUT    | `/campaigns/:id` | Update campaign by ID |
| DELETE | `/campaigns/:id` | Delete campaign by ID |

### Donations

| Method | Path                            | Description                     |
| ------ | ------------------------------- | ------------------------------- |
| GET    | `/donations/project/:projectId` | List donations for a project    |
| POST   | `/donations/project/:projectId` | Create a donation for a project |
| GET    | `/donations/:id`                | Get a donation by ID            |
| DELETE | `/donations/:id`                | Delete a donation by ID         |
| POST   | `/donations/webhook/stripe`     | Stripe webhook handling         |
| POST   | `/donations/webhook/myfatoora`  | MyFatoora webhook handling      |

### Stripe Gateway

| Method | Path                          | Description                           |
| ------ | ----------------------------- | ------------------------------------- |
| POST   | `/stripe/webhook`             | Stripe webhook endpoint               |
| GET    | `/stripe/status/:id`          | Check Stripe payment status           |
| GET    | `/stripe/success/:donationId` | Redirect on successful Stripe payment |
| GET    | `/stripe/cancel/:donationId`  | Redirect on canceled Stripe payment   |

### MyFatoora Gateway

| Method | Path                             | Description                              |
| ------ | -------------------------------- | ---------------------------------------- |
| POST   | `/myfatoora/webhook`             | MyFatoora webhook endpoint               |
| GET    | `/myfatoora/status/:id`          | Check MyFatoora payment status           |
| GET    | `/myfatoora/success/:donationId` | Redirect on successful MyFatoora payment |
| GET    | `/myfatoora/cancel/:donationId`  | Redirect on canceled MyFatoora payment   |

## Security Features

- JWT-based authentication
- Role-based access control
- Request validation
- Data encryption
- Secure password handling
- Protected admin routes

## Project Structure

```
‚îî‚îÄ‚îÄ üìÅsrc
    ‚îî‚îÄ‚îÄ üìÅadmin
        ‚îî‚îÄ‚îÄ admin.controller.ts
        ‚îî‚îÄ‚îÄ admin.module.ts
        ‚îî‚îÄ‚îÄ admin.service.ts
    ‚îî‚îÄ‚îÄ üìÅauth
        ‚îî‚îÄ‚îÄ auth.controller.ts
        ‚îî‚îÄ‚îÄ auth.module.ts
        ‚îî‚îÄ‚îÄ auth.service.ts
        ‚îî‚îÄ‚îÄ üìÅdto
            ‚îî‚îÄ‚îÄ login.dto.ts
            ‚îî‚îÄ‚îÄ otp-verify.dto.ts
            ‚îî‚îÄ‚îÄ register.dto.ts
    ‚îî‚îÄ‚îÄ üìÅbanners
        ‚îî‚îÄ‚îÄ banners.controller.ts
        ‚îî‚îÄ‚îÄ banners.module.ts
        ‚îî‚îÄ‚îÄ banners.service.ts
        ‚îî‚îÄ‚îÄ üìÅdto
            ‚îî‚îÄ‚îÄ create-banner.dto.ts
            ‚îî‚îÄ‚îÄ update-banner.dto.ts
        ‚îî‚îÄ‚îÄ üìÅentities
            ‚îî‚îÄ‚îÄ banner.entity.ts
    ‚îî‚îÄ‚îÄ üìÅcampaigns
        ‚îî‚îÄ‚îÄ campaigns.controller.ts
        ‚îî‚îÄ‚îÄ campaigns.module.ts
        ‚îî‚îÄ‚îÄ campaigns.service.ts
        ‚îî‚îÄ‚îÄ üìÅdto
            ‚îî‚îÄ‚îÄ createCampaignDto.ts
            ‚îî‚îÄ‚îÄ UpdateCampaignDto.ts
        ‚îî‚îÄ‚îÄ üìÅentities
            ‚îî‚îÄ‚îÄ campaign.entity.ts
    ‚îî‚îÄ‚îÄ üìÅcategories
        ‚îî‚îÄ‚îÄ categories.controller.ts
        ‚îî‚îÄ‚îÄ categories.module.ts
        ‚îî‚îÄ‚îÄ categories.service.ts
        ‚îî‚îÄ‚îÄ üìÅdto
            ‚îî‚îÄ‚îÄ create-category.dto.ts
            ‚îî‚îÄ‚îÄ update-category.dto.ts
        ‚îî‚îÄ‚îÄ üìÅentities
            ‚îî‚îÄ‚îÄ category.entity.ts
    ‚îî‚îÄ‚îÄ üìÅcommon
        ‚îî‚îÄ‚îÄ üìÅconfigs
            ‚îî‚îÄ‚îÄ media.config.ts
        ‚îî‚îÄ‚îÄ üìÅconstants
            ‚îî‚îÄ‚îÄ campaignPurpose.constant.ts
            ‚îî‚îÄ‚îÄ campaignStatus.constant.ts
            ‚îî‚îÄ‚îÄ donationStatus.constant.ts
            ‚îî‚îÄ‚îÄ media.constant.ts
            ‚îî‚îÄ‚îÄ payment.constant.ts
            ‚îî‚îÄ‚îÄ project.constant.ts
            ‚îî‚îÄ‚îÄ roles.constant.ts
            ‚îî‚îÄ‚îÄ t.constant.ts
        ‚îî‚îÄ‚îÄ üìÅdecorators
            ‚îî‚îÄ‚îÄ public.decorator.ts
            ‚îî‚îÄ‚îÄ roles.decorator.ts
        ‚îî‚îÄ‚îÄ üìÅguards
            ‚îî‚îÄ‚îÄ jwt-auth.guard.ts
            ‚îî‚îÄ‚îÄ roles.guard.ts
        ‚îî‚îÄ‚îÄ üìÅinterceptors
            ‚îî‚îÄ‚îÄ traffic.interceptor.ts
        ‚îî‚îÄ‚îÄ üìÅinterfaces
            ‚îî‚îÄ‚îÄ jwt-payload.interface.ts
            ‚îî‚îÄ‚îÄ myfatoora.interface.ts
            ‚îî‚îÄ‚îÄ payment-service.interface.ts
            ‚îî‚îÄ‚îÄ payment.interface.ts
        ‚îî‚îÄ‚îÄ üìÅmail
            ‚îî‚îÄ‚îÄ mail.module.ts
            ‚îî‚îÄ‚îÄ mail.service.ts
        ‚îî‚îÄ‚îÄ üìÅotp
            ‚îî‚îÄ‚îÄ otp.module.ts
            ‚îî‚îÄ‚îÄ otp.service.ts
        ‚îî‚îÄ‚îÄ üìÅpipes
            ‚îî‚îÄ‚îÄ campaignExists.pipe.ts
            ‚îî‚îÄ‚îÄ donationExists.pipe.ts
            ‚îî‚îÄ‚îÄ file-size.pipe.ts
            ‚îî‚îÄ‚îÄ file-type.pipe.ts
        ‚îî‚îÄ‚îÄ üìÅservices
            ‚îî‚îÄ‚îÄ logger.service.ts
            ‚îî‚îÄ‚îÄ monitoring.service.ts
        ‚îî‚îÄ‚îÄ üìÅstrategies
            ‚îî‚îÄ‚îÄ jwt.strategy.ts
            ‚îî‚îÄ‚îÄ refresh-token.strategy.ts
        ‚îî‚îÄ‚îÄ üìÅutils
            ‚îî‚îÄ‚îÄ otp-generator.util.ts
        ‚îî‚îÄ‚îÄ üìÅvalidators
            ‚îî‚îÄ‚îÄ mime-types.validator.ts
    ‚îî‚îÄ‚îÄ üìÅconfig
        ‚îî‚îÄ‚îÄ config.module.ts
        ‚îî‚îÄ‚îÄ config.service.ts
    ‚îî‚îÄ‚îÄ üìÅcontinents
        ‚îî‚îÄ‚îÄ continents.controller.ts
        ‚îî‚îÄ‚îÄ continents.module.ts
        ‚îî‚îÄ‚îÄ continents.service.ts
        ‚îî‚îÄ‚îÄ üìÅdto
            ‚îî‚îÄ‚îÄ create-continent.dto.ts
            ‚îî‚îÄ‚îÄ update-continent.dto.ts
        ‚îî‚îÄ‚îÄ üìÅentities
            ‚îî‚îÄ‚îÄ continent.entity.ts
    ‚îî‚îÄ‚îÄ üìÅcountries
        ‚îî‚îÄ‚îÄ countries.controller.ts
        ‚îî‚îÄ‚îÄ countries.module.ts
        ‚îî‚îÄ‚îÄ countries.service.ts
        ‚îî‚îÄ‚îÄ üìÅdto
            ‚îî‚îÄ‚îÄ create-country.dto.ts
            ‚îî‚îÄ‚îÄ update-country.dto.ts
        ‚îî‚îÄ‚îÄ üìÅentities
            ‚îî‚îÄ‚îÄ country.entity.ts
    ‚îî‚îÄ‚îÄ üìÅdonations
        ‚îî‚îÄ‚îÄ donations.controller.ts
        ‚îî‚îÄ‚îÄ donations.module.ts
        ‚îî‚îÄ‚îÄ donations.service.ts
        ‚îî‚îÄ‚îÄ üìÅdto
            ‚îî‚îÄ‚îÄ create-donation.dto.ts
            ‚îî‚îÄ‚îÄ update-donation.dto.ts
        ‚îî‚îÄ‚îÄ üìÅentities
            ‚îî‚îÄ‚îÄ donation.entity.ts
    ‚îî‚îÄ‚îÄ üìÅmedia
        ‚îî‚îÄ‚îÄ üìÅdto
            ‚îî‚îÄ‚îÄ create-media.dto.ts
            ‚îî‚îÄ‚îÄ update-media.dto.ts
        ‚îî‚îÄ‚îÄ üìÅentities
            ‚îî‚îÄ‚îÄ media.entity.ts
        ‚îî‚îÄ‚îÄ media.controller.ts
        ‚îî‚îÄ‚îÄ media.module.ts
        ‚îî‚îÄ‚îÄ media.service.ts
    ‚îî‚îÄ‚îÄ üìÅmyfatoora
        ‚îî‚îÄ‚îÄ myfatoora.controller.ts
        ‚îî‚îÄ‚îÄ myfatoora.module.ts
        ‚îî‚îÄ‚îÄ myfatoora.service.ts
    ‚îî‚îÄ‚îÄ üìÅprojects
        ‚îî‚îÄ‚îÄ üìÅdto
            ‚îî‚îÄ‚îÄ create-project.dto.ts
            ‚îî‚îÄ‚îÄ update-project.dto.ts
        ‚îî‚îÄ‚îÄ üìÅentities
            ‚îî‚îÄ‚îÄ project.entity.ts
        ‚îî‚îÄ‚îÄ projects.controller.ts
        ‚îî‚îÄ‚îÄ projects.module.ts
        ‚îî‚îÄ‚îÄ projects.service.ts
    ‚îî‚îÄ‚îÄ üìÅstripe
        ‚îî‚îÄ‚îÄ stripe.controller.ts
        ‚îî‚îÄ‚îÄ stripe.module.ts
        ‚îî‚îÄ‚îÄ stripe.service.ts
    ‚îî‚îÄ‚îÄ üìÅuser
        ‚îî‚îÄ‚îÄ üìÅdto
            ‚îî‚îÄ‚îÄ create-user.dto.ts
            ‚îî‚îÄ‚îÄ update-user.dto.ts
        ‚îî‚îÄ‚îÄ üìÅentities
            ‚îî‚îÄ‚îÄ user.entity.ts
        ‚îî‚îÄ‚îÄ user.controller.ts
        ‚îî‚îÄ‚îÄ user.module.ts
        ‚îî‚îÄ‚îÄ user.service.ts
    ‚îî‚îÄ‚îÄ app.controller.ts
    ‚îî‚îÄ‚îÄ app.module.ts
    ‚îî‚îÄ‚îÄ app.service.ts
    ‚îî‚îÄ‚îÄ main.ts
```

## üë§ Author

Developed by **Ali Dirawi** ‚Äì a passionate developer focused on **safety**, **AI**, and **embedded systems**.

> ## üë§ Author Info
>
> **Ali Dirawi** ‚Äî üáÆüá∂ _Iraq_
> üß† _Cybersecurity & AI Researcher_
> üì¨ [@AliDirawi on Telegram](https://t.me/deskram)
>
> ¬© 2025 The Global Gray Hat Group ‚Äî All rights reserved.
